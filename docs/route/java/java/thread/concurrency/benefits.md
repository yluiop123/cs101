# 多线程的好处

多线程最显著的好处包括：

- 更好的CPU利用率。
- 在某些情况下更简单的程序设计。
- 更具响应性的程序。
- 任务之间更公平的CPU资源分配。

## 更好的CPU利用率

设想一个从本地文件系统读取并处理文件的应用程序。假设从磁盘读取文件需要5秒，处理它需要2秒。处理两个文件则需要：

```
  5秒读取文件A
  2秒处理文件A
  5秒读取文件B
  2秒处理文件B
-----------------------
 14秒总计
```

在从磁盘读取文件时，大部分CPU时间都花在等待磁盘读取数据上。在那段时间里，CPU基本上处于空闲状态。它本可以做其他事情。通过改变操作顺序，可以更好地利用CPU。看这个排序：

```
  5秒读取文件A
  5秒读取文件B + 2秒处理文件A
  2秒处理文件B
-----------------------
 12秒总计
```

CPU等待第一个文件被读取。然后它开始读取第二个文件。当计算机的IO组件正在读取第二个文件时，CPU处理第一个文件。记住，在等待文件从磁盘读取时，CPU大部分时间是空闲的。

通常，CPU在等待IO时可以做其他事情。它不一定是磁盘IO。它也可以是网络IO，或者是机器上的用户输入。网络和磁盘IO通常比CPU和内存IO慢得多。

## 更简单的程序设计

如果你要在单线程应用程序中手动按上述顺序编程读取和处理，你必须跟踪每个文件的读取和处理状态。相反，你可以启动两个线程，每个线程只读取和处理一个文件。这些线程在等待磁盘读取其文件时将被阻塞。在等待时，其他线程可以使用CPU处理它们已经读取的文件部分。结果是，磁盘始终忙碌，不断地从不同文件中读取到内存中。这导致了磁盘和CPU的更好利用。

程序也更容易编写，因为每个线程只需要注意一个文件。

## 更具响应性的程序

将单线程应用程序转换为多线程应用程序的另一个常见目标是实现更具响应性的应用程序。想象一个监听某些端口以接收传入请求的服务器应用程序。当收到请求时，它处理请求，然后返回监听。服务器循环如下所示：

```
  while(server is active){
    listen for request
    process request
  }
```

如果请求处理时间很长，那么在这段时间内没有新客户端可以向服务器发送请求。只有在服务器监听时才能接收请求。

另一种设计是让监听线程将请求传递给工作线程，并立即返回监听。工作线程将处理请求并向客户端发送回复。这种设计如下所示：

```
  while(server is active){
    listen for request
    hand request to worker thread
  }
```

这样，服务器线程将更快地回到监听状态。因此，更多的客户端可以向服务器发送请求。服务器变得更加响应。

桌面应用程序也是如此。如果您点击一个按钮启动一个长任务，执行任务的线程是更新窗口、按钮等的线程，那么在执行任务期间应用程序将显得无响应。相反，任务可以交给工作线程处理。当工作线程忙于任务时，窗口线程可以自由地响应其他用户请求。当工作线程完成后，它向窗口线程发出信号。然后窗口线程可以用任务的结果更新应用程序窗口。采用工作线程设计程序对用户来说会显得更加响应。

## 更公平的CPU资源分配

想象一个从客户端接收请求的服务器。想象一下，其中一个客户端发送了一个处理时间很长的请求 - 例如10秒。如果服务器使用单个线程处理所有任务，那么所有在处理慢请求之后的所有请求将被迫等待直到整个请求被处理完毕。

通过在多个线程之间分配CPU时间并在线程之间切换，CPU就可以更公平地在多个请求之间共享其执行时间。即使其中一个请求很慢，其他处理速度更快的请求也可以与慢请求同时执行。当然，这意味着执行慢请求将变得更慢，因为它不会完全分配CPU只处理它。然而，其他请求将等待较短时间被处理，因为它们不必等待慢任务完成才能被处理。如果只有慢请求需要处理，那么CPU仍然可以完全分配给慢任务。

